<!DOCTYPE html>
<html>
    <head>
        <title></title>
        <meta
            name="viewport"
            content="minimum-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
        <style type="text/css" media="screen">
           html {
                width: 100%;
                height: 100%;
            }
            body {
                background-color:'#ffffff';
                width: 100%;
                height: 100%;
            }

        </style>
    </head>
    <body ontouchstart>
        <script src="painting.min.js" type="text/javascript"></script>
        <div
            id="imgBox"
            style="position:fixed;left:0;top:0;display: none;">
            <img src="" id="testImg" alt="" style="position: absolute; width: 100%;object-fit: contain;"/>
        </div>
    </body>
    <script>
        var topPx;
        var isIOS;
        var alloyFinger;
        var el = document.getElementById("testImg");
        // imageLoaded("#testImg", function (w, h) {
        //     document
        //         .querySelector("#imgBox")
        //         .style
        //         .display = "block";
        //     this.style.top = topPx + "px";
        // });


       
        window.onload = function () {
            window.addEventListener('message', function (e) {
                    var json = e.data;
                    var message = json.payload;
                    switch (json.type) {
                        case 'init':
                            var imgBox = document.getElementById('imgBox');
                            imgBox.style.width = message.mWidth + 'px';
                            imgBox.style.height = message.mHeight+ 'px';
                            el.src = message.imgPath;
                            el.onload = function(){
                                document
                                        .querySelector("#imgBox")
                                        .style
                                        .display = "block";
                                topPx = window.innerHeight / 2 - (el.height * window.innerWidth / el.width) / 2;
                                el.style.top = topPx + "px";
                            }
                            isIOS = message.isIOS;
                            if(alloyFinger==null){
                                var orientation = message.orientation;
                                var rotate = 0;
                                switch (orientation){
                                    case 3 :
                                    case 4 :
                                        rotate = 180;
                                        break;
                                    case 5 :    
                                    case 6 :
                                        rotate = 90;
                                        break;
                                    case 7 :
                                    case 8 :
                                        rotate = 270;
                                        break
                                    default:
                                        rotate = 0;    
                                }
                                initAlloFinger(rotate);
                            }
                            break;
                    }
                })
        }
        function ease(x) {
            return Math.sqrt(1 - Math.pow(x - 1, 2));
        }
        function initAlloFinger (rotate){
            Transform(el,rotate);
            var initScale = 1;
            alloyFinger=new AlloyFinger(el, {
                multipointStart: function () {
                    To.stopAll();
                    initScale = el.scaleX;
                },
                rotate: function (evt) {
                    el.rotateZ += evt.angle;
                },
                pinch: function (evt) {
                    el.scaleX = el.scaleY = initScale * evt.scale;
                },
                
                pressMove: function (evt) {
                    el.translateX += evt.deltaX;
                    el.translateY += evt.deltaY;
                    evt.preventDefault();
                },
                tap: function (evt) {
                    // console.log(el.scaleX + "_" + el.scaleY + "_" + el.rotateZ + "_" +
                    // el.translateX + "_" + el.translateY); console.log("tap");
                },
                doubleTap: function (evt) {
                    // To.stopAll();
                    // if (el.scaleX > 1.5) {

                    //     new To(el, "scaleX", 1, 500, ease);
                    //     new To(el, "scaleY", 1, 500, ease);
                    //     new To(el, "translateX", 0, 500, ease);
                    //     new To(el, "translateY", 0, 500, ease);
                    // } else {
                    //     var box = el.getBoundingClientRect();
                    //     var y = box.height - ((evt.changedTouches[0].pageY - topPx) * 2) - (box.height / 2 - (evt.changedTouches[0].pageY - topPx));

                    //     var x = box.width - ((evt.changedTouches[0].pageX) * 2) - (box.width / 2 - (evt.changedTouches[0].pageX));
                    //     new To(el, "scaleX", 2, 500, ease);
                    //     new To(el, "scaleY", 2, 500, ease);
                    //     new To(el, "translateX", x, 500, ease);
                    //     new To(el, "translateY", y, 500, ease);
                    // }
                    //console.log("doubleTap");
                },
                longTap: function (evt) {
                    //console.log("longTap");
                },
                swipe: function (evt) {
                    //console.log("swipe" + evt.direction);
                }

            });
            // if (!isIOS) {
            //     el.rotateZ = 0;
            // }
        }
        //此监听是为了解决Android 某些机型 无法响应 el 的 touchmove
        document
            .body
            .addEventListener('touchmove', function (e) {})
    </script>
</html>